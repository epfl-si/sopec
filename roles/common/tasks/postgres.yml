- name: Build postgres roles
  set_fact:
    postgres_roles: "{{ postgres_roles | default([]) + [role_item] }}"
  vars:
    role_item:
      name: "{{ item }}-user"
      ensure: present
      login: true
      superuser: false
      passwordSecret:
        name: "{{ item }}-db-credentials"
  loop: "{{ postgres_users }}"

- name: Deploy PostgreSQL cluster
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: postgresql.cnpg.io/v1
      kind: Cluster
      metadata:
        name: postgres-cluster
        namespace: "{{ openshift_namespace }}"
      spec:
        instances: 2
        storage:
          size: "10Gi"
          storageClass: "sopec"
        enableSuperuserAccess: true
        resources:
          requests:
            cpu: "500m"
            memory: "500Mi"
          limits:
            memory: "1Gi"
        managed:
          roles: "{{ postgres_roles }}"
